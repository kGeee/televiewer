---
phase: 01-correlation-engine
plan: 04
type: execute
wave: 2
depends_on: ['01-01', '01-02', '01-03']
files_modified:
  [
    'src/routes/api/sessions/[id]/correlate/+server.ts',
    'src/lib/server/merge.ts',
    'src/routes/sessions/[id]/+page.svelte',
    'src/routes/sessions/[id]/CorrelationIndicator.svelte'
  ]
autonomous: false

user_setup: []

must_haves:
  truths:
    - 'API endpoint /api/sessions/[id]/correlate accepts two telemetry sources and returns offset + confidence'
    - 'Session detail page displays correlation confidence indicator (green/yellow/red badge)'
    - 'Low-confidence correlations show warning message with manual adjustment option'
    - 'Correlation completes in <2 seconds for typical session data'
  artifacts:
    - path: 'src/routes/api/sessions/[id]/correlate/+server.ts'
      provides: 'API endpoint for correlation'
      exports: ['POST']
    - path: 'src/routes/sessions/[id]/CorrelationIndicator.svelte'
      provides: 'Visual confidence indicator component'
      exports: ['default']
    - path: 'src/routes/sessions/[id]/+page.svelte'
      provides: 'Integration point for correlation UI'
      modifies: 'Adds correlation UI elements'
  key_links:
    - from: '+server.ts'
      to: 'correlation.ts'
      via: 'imports correlateWithAssessment'
      pattern: 'import.*correlate'
    - from: 'CorrelationIndicator.svelte'
      to: 'getConfidenceColor'
      via: 'imports from analysis'
      pattern: 'getConfidenceColor|assessConfidence'
---

<objective>
Integrate correlation engine into the application: API endpoint and UI components for displaying correlation results.

Purpose: Make correlation engine accessible to users through the existing session detail workflow.
Output: Working API endpoint and UI components for correlation confidence display.
</objective>

<execution_context>
@/Users/kevingeorge/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/kevingeorge/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/Users/kevingeorge/Documents/projects/flyinglizards/.planning/phases/01-correlation-engine/01-01-PLAN.md
@/Users/kevingeorge/Documents/projects/flyinglizards/.planning/phases/01-correlation-engine/01-02-PLAN.md
@/Users/kevingeorge/Documents/projects/flyinglizards/.planning/phases/01-correlation-engine/01-03-PLAN.md
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/analysis/index.ts
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/server/db/schema.ts
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/server/merge.ts

# Database schema has: drivers, sessions, laps, telemetry tables

# Session detail page at /sessions/[id] displays telemetry

# Need to add correlation capability for merging secondary telemetry files

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correlation API endpoint</name>
  <files>src/routes/api/sessions/[id]/correlate/+server.ts</files>
  <action>
    Create SvelteKit API endpoint for correlation:
    
    1. Create directory: src/routes/api/sessions/[id]/correlate/
    
    2. Create +server.ts with POST handler:
       import { json } from '@sveltejs/kit'
       import { correlateWithAssessment } from '$lib/analysis'
       import { db } from '$lib/server/db/client'
       
       export async function POST({ params, request }) {
         const sessionId = params.id
         const { primaryLapIds, secondaryTelemetry } = await request.json()
         
         // Fetch primary laps telemetry from database
         const primaryData = await db.query.laps.findMany({
           where: { id: { in: primaryLapIds } },
           with: { telemetry: true }
         })
         
         // Extract speed channels
         const primarySpeed = primaryData.flatMap(lap => 
           lap.telemetry?.speed || []
         )
         const primaryTime = primaryData.flatMap(lap => 
           lap.telemetry?.time || []
         )
         
         // secondaryTelemetry: { speed: number[], time: number[] }
         const secondarySpeed = secondaryTelemetry.speed
         const secondaryTime = secondaryTelemetry.time
         
         // Run correlation
         const { result, assessment } = correlateWithAssessment(
           primarySpeed,
           secondarySpeed,
           primaryTime,
           secondaryTime,
           { maxOffsetSeconds: 300 }
         )
         
         return json({
           offset: result.offset,
           confidence: result.confidence,
           assessment: {
             level: assessment.level,
             color: assessment.color,
             message: assessment.message,
             requiresReview: assessment.requiresReview
           }
         })
       }
    
    3. Handle error cases:
       - Missing telemetry data → 400 with error message
       - No speed channel → 400 "Speed channel required for correlation"
       - Signals too short (<50 samples) → 400 "Insufficient data"
       - Correlation failure → 500 with error details
    
    4. Add request/response type definitions in a separate types file or inline
    
    5. Test endpoint with curl or postman (can use +page.server.ts to test internally)
  </action>
  <verify>npm run check 2>&1 | grep -E "(error|Error)" | grep -v "0 errors" || echo "Type check passed"</verify>
  <done>+server.ts created with POST handler, type-checks clean, handles errors</done>
</task>

<task type="auto">
  <name>Task 2: Create CorrelationIndicator component</name>
  <files>src/routes/sessions/[id]/CorrelationIndicator.svelte</files>
  <action>
    Create Svelte component for correlation confidence display:
    
    1. Create CorrelationIndicator.svelte:
       ```svelte
       <script lang="ts">
         import { getConfidenceColor, type ConfidenceAssessment } from '$lib/analysis'
         
         export let assessment: ConfidenceAssessment
         export let offset: number
       </script>
       
       <div class="correlation-indicator">
         <div class="flex items-center gap-2">
           <span class="badge {getConfidenceColor(assessment.score)}">
             {assessment.level.toUpperCase()}
           </span>
           <span class="text-sm">Confidence: {(assessment.score * 100).toFixed(0)}%</span>
           <span class="text-sm">Offset: {offset > 0 ? '+' : ''}{offset.toFixed(2)}s</span>
         </div>
         
         {#if assessment.requiresReview}
           <div class="warning mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
             <p class="text-sm text-yellow-800">{assessment.message}</p>
             <p class="text-xs text-yellow-600 mt-1">{assessment.recommendation}</p>
           </div>
         {:else}
           <p class="text-sm text-gray-600 mt-1">{assessment.message}</p>
         {/if}
       </div>
       ```
    
    2. Use Tailwind classes for styling:
       - Badge: inline-flex, px-2, py-1, rounded, text-xs, font-medium
       - Colors: green (bg-green-100 text-green-800), yellow (bg-yellow-100 text-yellow-800), red (bg-red-100 text-red-800)
    
    3. Make component props reactive and handle undefined assessment gracefully
    
    4. Add to index export if needed for other components
    
    5. Type check component
  </action>
  <verify>npm run check -- --filter CorrelationIndicator.svelte 2>&1 | grep -v "error" || echo "Component type check passed"</verify>
  <done>CorrelationIndicator.svelte created with confidence display and warning UI</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Integrate and verify UI</name>
  <what-built>
    Complete correlation engine integration:
    - API endpoint at /api/sessions/[id]/correlate
    - CorrelationIndicator Svelte component
    - Updated session detail page structure
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Open browser to http://localhost:5173/sessions
    3. Select any existing session
    4. Verify session detail page loads without errors
    5. Check browser console for any JavaScript errors related to correlation
    6. Verify CorrelationIndicator component renders (may need to temporarily add test data to page)
    
    To manually test correlation endpoint:
    ```bash
    curl -X POST http://localhost:5173/api/sessions/1/correlate \
      -H "Content-Type: application/json" \
      -d '{
        "primaryLapIds": [1],
        "secondaryTelemetry": {
          "speed": [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
          "time": [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
        }
      }'
    ```
    
    Expected: JSON response with offset, confidence, and assessment fields.
  </how-to-verify>
  <resume-signal>Type "approved" if UI displays correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. API endpoint responds to POST with correlation results
2. CorrelationIndicator displays confidence with color coding
3. Low confidence (<0.7) shows warning with recommendation
4. Manual test via curl returns expected JSON structure
5. Session detail page loads without correlation-related errors
</verification>

<success_criteria>

- API endpoint exists at /api/sessions/[id]/correlate
- POST returns { offset, confidence, assessment } JSON
- CorrelationIndicator.svelte displays confidence level and color
- Green badge for >0.8, yellow for 0.6-0.8, red for <0.6
- Warning message displayed when requiresReview is true
- Type checking passes for all new files
- Dev server runs without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-correlation-engine/01-04-SUMMARY.md`
</output>
