---
phase: 01-correlation-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified: ['src/lib/analysis/correlation.ts', 'src/lib/analysis/correlation.test.ts']
autonomous: true

must_haves:
  truths:
    - 'System can compute time offset between two speed signals with ±0.1s accuracy'
    - 'Cross-correlation returns correlation coefficient as confidence metric'
    - 'Algorithm handles signals of different lengths'
    - 'Algorithm completes in <2 seconds for 100 laps at 10Hz'
  artifacts:
    - path: 'src/lib/analysis/correlation.ts'
      provides: 'Cross-correlation algorithm with Pearson correlation'
      exports: ['crossCorrelate', 'findTimeOffset']
    - path: 'src/lib/analysis/correlation.test.ts'
      provides: 'Comprehensive unit tests'
      min_tests: 8
  key_links:
    - from: 'correlation.ts'
      to: 'correlation.test.ts'
      via: 'import and test'
      pattern: 'crossCorrelate'
---

<objective>
Implement core cross-correlation algorithm for time offset detection using Pearson correlation coefficient.

Purpose: Core algorithm for Phase 1 — must reliably detect time offsets between telemetry sources with quantifiable confidence.
Output: Working correlation.ts module with comprehensive tests, exported functions for cross-correlation and time offset detection.
</objective>

<execution_context>
@/Users/kevingeorge/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/kevingeorge/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/server/merge.ts
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/server/merge.test.ts

# Existing simple cross-correlation exists in merge.ts but needs upgrade:

# - Current: findTimeOffset uses covariance (sum product), not Pearson correlation

# - Needed: Pearson correlation coefficient (-1 to 1) for proper confidence scoring

# - Must support normalized signals and proper lag window handling

</context>

<feature>
  <name>Cross-Correlation with Pearson Correlation</name>
  <files>src/lib/analysis/correlation.ts, src/lib/analysis/correlation.test.ts</files>
  <behavior>
    Compute time offset between two speed signals using normalized cross-correlation.
    
    Test Cases:
    1. Identical signals → offset 0s, confidence 1.0
    2. Signal B delayed by 2.5s → offset +2.5s, confidence >0.9
    3. Signal B ahead by 1.3s → offset -1.3s, confidence >0.9
    4. Uncorrelated signals → confidence <0.3
    5. Partial overlap (B is subset of A) → offset detected, confidence adjusted for overlap ratio
    6. Different sample rates (10Hz vs 100Hz) → resampled internally, correct offset
    7. Noisy signals (±5% noise) → offset ±0.1s, confidence >0.7
    8. Performance: 10,000 samples (1000s at 10Hz) completes <2s
    
    Interface:
    ```typescript
    interface CorrelationResult {
      offset: number;        // Time offset in seconds
      confidence: number;    // Pearson correlation coefficient 0-1
      lag: number;           // Sample lag (for internal use)
    }
    
    function crossCorrelate(
      signalA: number[],
      signalB: number[],
      timeA: number[],
      timeB: number[],
      maxOffsetSeconds?: number  // Default: 300 (5 min)
    ): CorrelationResult
    ```
  </behavior>
  <implementation>
    Algorithm steps:
    1. Resample both signals to common frequency (10Hz default)
    2. Normalize signals (zero mean, unit variance) using z-score
    3. Apply Hanning window to reduce edge effects
    4. Compute normalized cross-correlation across lag window
    5. Find peak correlation and corresponding lag
    6. Convert lag to time offset
    7. Return confidence as normalized peak correlation (0-1)
    
    Use Float64Array for performance on large arrays.
    Limit lag range to ±maxOffsetSeconds * sampleRate for efficiency.
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>RED: Write failing tests</name>
  <files>src/lib/analysis/correlation.test.ts</files>
  <action>
    Create correlation.test.ts with comprehensive test suite BEFORE implementation:
    
    1. Import { describe, it, expect } from 'vitest'
    2. Import functions to test from './correlation' (will fail initially)
    3. Write tests for all 8 test cases defined in <feature> behavior section
    
    Test helper functions to create:
    - generateSpeedSignal(basePattern, sampleRate, duration, offset?): Create synthetic speed data
    - addNoise(signal, noiseLevel): Add random noise to signal
    
    Each test must have clear expected values:
    - expect(result.offset).toBeCloseTo(expectedOffset, 1) // ±0.1s
    - expect(result.confidence).toBeGreaterThan(minConfidence)
    
    Run tests with `npm test` or vitest - they MUST fail (RED phase complete when tests fail due to missing imports/functions).
  </action>
  <verify>npm test src/lib/analysis/correlation.test.ts 2>&1 | grep -E "(FAIL|fail|Error|not found)"</verify>
  <done>Test file exists with 8+ test cases, all failing due to missing implementation</done>
</task>

<task type="auto">
  <name>GREEN: Implement correlation algorithm</name>
  <files>src/lib/analysis/correlation.ts</files>
  <action>
    Create correlation.ts with minimal implementation to make tests pass:
    
    1. Export CorrelationResult interface
    2. Implement crossCorrelate function:
       - Accept signalA, signalB, timeA, timeB, maxOffsetSeconds (default 300)
       - Determine common sample rate (default 10Hz if different)
       - Resample signals to common time base if needed
       - Z-score normalize both signals: (x - mean) / std
       - Apply Hanning window: w[n] = 0.5 - 0.5 * cos(2πn/(N-1))
       - Compute cross-correlation for lag range [-maxLag, +maxLag]
       - For each lag, calculate Pearson correlation on overlapping region
       - Find peak correlation value and corresponding lag
       - Return { offset: lag/sampleRate, confidence: peakCorr, lag }
    
    3. Export findTimeOffset wrapper for backward compatibility with merge.ts
    
    Use Float64Array for numeric operations.
    Optimize with early exit for zero overlap regions.
    
    Run tests - they MUST pass (GREEN phase complete when all tests pass).
  </action>
  <verify>npm test src/lib/analysis/correlation.test.ts 2>&1 | grep -E "(passed|PASS|✓)" | head -5</verify>
  <done>All 8 tests pass with correct offset detection (±0.1s) and confidence scores</done>
</task>

<task type="auto">
  <name>REFACTOR: Optimize and clean up</name>
  <files>src/lib/analysis/correlation.ts</files>
  <action>
    Optimize correlation implementation for performance:
    
    1. Add precomputed window coefficients cache
    2. Use typed arrays (Float64Array) consistently
    3. Add performance benchmark test (optional but helpful)
    4. Add JSDoc comments for all exported functions
    5. Ensure no console.log statements in production code
    6. Verify tests still pass after refactoring
    
    Optional: Add diagnostic function to return full correlation array for visualization.
    
    Run full test suite to ensure no regressions.
  </action>
  <verify>npm test src/lib/analysis/correlation.test.ts && npm run check</verify>
  <done>Tests pass, type checking passes, performance verified (<2s for 10k samples)</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm test src/lib/analysis/correlation.test.ts` - all tests must pass
2. Run `npm run check` - TypeScript must have no errors
3. Verify exports include: crossCorrelate, findTimeOffset, CorrelationResult
</verification>

<success_criteria>

- crossCorrelate function exists and is exported
- Can detect ±0.1s accuracy on synthetic signals
- Returns confidence score (0-1) as Pearson correlation coefficient
- Handles signals of different lengths and sample rates
- All 8+ unit tests pass
- Type checking passes with no errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-correlation-engine/01-01-SUMMARY.md`
</output>
