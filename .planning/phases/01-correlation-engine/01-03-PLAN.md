---
phase: 01-correlation-engine
plan: 03
type: execute
wave: 2
depends_on: ['01-01', '01-02']
files_modified:
  [
    'src/lib/analysis/confidence.ts',
    'src/lib/analysis/confidence.test.ts',
    'src/lib/analysis/types.ts'
  ]
autonomous: true

must_haves:
  truths:
    - 'System calculates confidence score (0-1) from Pearson correlation'
    - 'Confidence levels mapped to colors: green (>0.8), yellow (0.6-0.8), red (<0.6)'
    - 'Low-confidence results (<0.7) trigger warning requiring manual review'
    - 'Assessment includes human-readable message explaining confidence'
  artifacts:
    - path: 'src/lib/analysis/confidence.ts'
      provides: 'Confidence assessment and scoring'
      exports: ['assessConfidence', 'getConfidenceColor', 'ConfidenceAssessment']
    - path: 'src/lib/analysis/types.ts'
      provides: 'Shared types for correlation system'
      exports: ['CorrelationResult', 'ConfidenceLevel', 'ConfidenceAssessment']
    - path: 'src/lib/analysis/confidence.test.ts'
      provides: 'Confidence scoring tests'
      min_tests: 5
  key_links:
    - from: 'confidence.ts'
      to: 'correlation.ts'
      via: 'imports CorrelationResult'
      pattern: 'CorrelationResult'
---

<objective>
Implement confidence scoring system with visual indicators and warning thresholds.

Purpose: Users need clear feedback on correlation quality to know when to trust auto-alignment vs. manually adjust.
Output: Confidence assessment module with color coding, thresholds, and human-readable messages.
</objective>

<execution_context>
@/Users/kevingeorge/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/kevingeorge/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/Users/kevingeorge/Documents/projects/flyinglizards/.planning/phases/01-correlation-engine/01-01-PLAN.md
@/Users/kevingeorge/Documents/projects/flyinglizards/.planning/phases/01-correlation-engine/01-02-PLAN.md
@/Users/kevingeorge/Documents/projects/flyinglizards/src/lib/analysis/correlation.ts

# Requirements from ROADMAP:

# - Confidence score (0-1) with color coding (green >0.8, yellow 0.6-0.8, red <0.6)

# - Low-confidence results (<0.7) trigger warning prompting manual review

#

# Depends on correlation.ts for CorrelationResult interface

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared types module</name>
  <files>src/lib/analysis/types.ts, src/lib/analysis/correlation.ts, src/lib/analysis/preprocessing.ts</files>
  <action>
    Create central types.ts file for correlation engine:
    
    1. Move CorrelationResult interface from correlation.ts to types.ts
       interface CorrelationResult {
         offset: number;
         confidence: number;
         lag: number;
         sampleRate: number;
         overlapRatio: number;
       }
    
    2. Define confidence-related types:
       type ConfidenceLevel = 'high' | 'medium' | 'low';
       
       interface ConfidenceAssessment {
         level: ConfidenceLevel;
         score: number;           // Raw correlation 0-1
         color: 'green' | 'yellow' | 'red';
         message: string;         // Human-readable explanation
         requiresReview: boolean; // True if confidence < 0.7
         recommendation: string;  // Action to take
       }
    
    3. Update correlation.ts:
       - Import CorrelationResult from './types'
       - Export { CorrelationResult } from './types' for backward compatibility
       - Remove duplicate interface definition
    
    4. Update preprocessing.ts:
       - Import any needed types from './types'
       - Export preprocessing-specific types if any
    
    5. Create index.ts barrel export if not exists:
       src/lib/analysis/index.ts exporting all public APIs
    
    Run type check to ensure no conflicts.
  </action>
  <verify>npm run check 2>&1 | grep -v "error" || echo "Type check passed"</verify>
  <done>types.ts created with all correlation types, correlation.ts and preprocessing.ts updated to use it</done>
</task>

<task type="auto">
  <name>Task 2: Implement confidence assessment</name>
  <files>src/lib/analysis/confidence.ts, src/lib/analysis/confidence.test.ts</files>
  <action>
    Create confidence.ts with assessment logic:
    
    1. Import types from './types'
    
    2. Define thresholds (constants):
       const HIGH_CONFIDENCE = 0.8;
       const MEDIUM_CONFIDENCE_MIN = 0.6;
       const REVIEW_THRESHOLD = 0.7;
    
    3. Implement assessConfidence(result: CorrelationResult): ConfidenceAssessment
       - Extract confidence score from result
       - Determine level based on thresholds:
         * score > HIGH_CONFIDENCE → 'high', 'green'
         * score > MEDIUM_CONFIDENCE_MIN → 'medium', 'yellow'
         * else → 'low', 'red'
       - Set requiresReview = score < REVIEW_THRESHOLD
       - Generate message based on level and overlapRatio:
         * High: "Strong correlation detected (X% match). Auto-alignment reliable."
         * Medium: "Moderate correlation (X% match). Review alignment if results seem off."
         * Low: "Weak correlation (X% match). Manual alignment recommended."
       - Generate recommendation:
         * High: "No action needed"
         * Medium: "Consider verifying alignment visually"
         * Low: "Use manual offset adjustment"
       - Return complete ConfidenceAssessment object
    
    4. Implement getConfidenceColor(score: number): string
       - Return CSS color class or hex value based on score
       - >0.8: 'green' (or tailwind class 'text-green-500')
       - 0.6-0.8: 'yellow' (or 'text-yellow-500')
       - <0.6: 'red' (or 'text-red-500')
    
    5. Create confidence.test.ts with tests:
       - High confidence (0.85) → level 'high', color 'green', requiresReview false
       - Medium confidence (0.7) → level 'medium', color 'yellow', requiresReview false
       - Low confidence (0.5) → level 'low', color 'red', requiresReview true
       - Edge case: exactly 0.8 → 'high'
       - Edge case: exactly 0.6 → 'medium'
       - Test message content contains expected keywords
    
    Run tests with `npm test src/lib/analysis/confidence.test.ts`
  </action>
  <verify>npm test src/lib/analysis/confidence.test.ts 2>&1 | grep -E "(passed|PASS|✓)" | wc -l</verify>
  <done>confidence.ts with assessConfidence and getConfidenceColor, 5+ tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Add confidence to correlation workflow</name>
  <files>src/lib/analysis/correlation.ts, src/lib/analysis/index.ts</files>
  <action>
    Integrate confidence assessment into correlation workflow:
    
    1. Update crossCorrelate to return enhanced result:
       - Ensure overlapRatio is properly calculated in CorrelationResult
       - overlapRatio = overlapLength / min(signalA.length, signalB.length)
    
    2. Create convenience function correlateWithAssessment:
       export function correlateWithAssessment(
         signalA: number[],
         signalB: number[],
         timeA: number[],
         timeB: number[],
         options?: CrossCorrelationOptions
       ): { result: CorrelationResult; assessment: ConfidenceAssessment }
       
       This function:
       - Calls crossCorrelate to get correlation result
       - Calls assessConfidence to get assessment
       - Returns both in single object for convenience
    
    3. Update index.ts barrel exports:
       export * from './types'
       export * from './correlation'
       export * from './preprocessing'
       export * from './confidence'
    
    4. Verify integration by creating simple integration test:
       - Test that correlateWithAssessment returns both result and assessment
       - Test that assessment.requiresReview is true for low confidence
       - Test that high confidence results have requiresReview false
    
    5. Run full analysis test suite:
       npm test src/lib/analysis/
  </action>
  <verify>npm test src/lib/analysis/ 2>&1 | tail -10 | grep -E "(passed|failed|Tests)"</verify>
  <done>correlateWithAssessment implemented, index.ts barrel export complete, all tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm test src/lib/analysis/` - all analysis tests pass
2. Run `npm run check` - no TypeScript errors
3. Verify exports from index.ts: types, correlation, preprocessing, confidence
4. Verify confidence thresholds: >0.8 green, 0.6-0.8 yellow, <0.6 red, <0.7 requiresReview
</verification>

<success_criteria>

- types.ts exists with CorrelationResult, ConfidenceLevel, ConfidenceAssessment
- confidence.ts exists with assessConfidence and getConfidenceColor functions
- Confidence thresholds: high (>0.8), medium (0.6-0.8), low (<0.6)
- requiresReview true when confidence < 0.7
- correlateWithAssessment convenience function exists
- index.ts barrel export provides clean API surface
- All tests pass (5+ confidence tests)
- Type checking passes
  </success_criteria>

<output>
After completion, create `.planning/phases/01-correlation-engine/01-03-SUMMARY.md`
</output>
